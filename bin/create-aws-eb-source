#!/usr/bin/env bash
set -e -u
shopt -s nullglob
: ${WDP:?"working directory path required"}
: ${GOOS:="linux"}
: ${GOARCH:="amd64"}

cd "${WDP}"

if [[ ! -e ./dist ]]; then
	mkdir "./dist"
fi

for f in ./dist/*; do
	rm "${f}"
done

go generate ./...

outPath="./dist/toggler"
GOOS=${GOOS} GOARCH=${GOARCH} go build -o "${outPath}" "./cmd/toggler/main.go"

procFilePath=./dist/Procfile
cat >"${procFilePath}" <<EOF
web: ./toggler http-server
EOF

zip --junk-paths dist/toggler.zip "${procFilePath}" "${outPath}"
rm "${procFilePath}"
rm "${outPath}"
